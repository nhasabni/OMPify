import os
import json
from tqdm import tqdm
import preprocess
from concurrent.futures.thread import ThreadPoolExecutor
import logging

logging.basicConfig(filename='clean_c.log', format='%(asctime)s - %(levelname)s - %(name)s -   %(message)s',datefmt='%d/%m/%Y %H:%M:%S',level=logging.INFO)
logger = logging.getLogger(__name__)


def remove_dups(js_file):
    '''
    remove duplicates from HPCorpus, using the hashed value
    '''
    hpcorpus_dir = '/tier2/bgu/HPCorpus'
    save_dir = '/tier2/bgu/HPCorpus_preprocess'
    langs = ['cpp']

    lang_dir = os.path.join(hpcorpus_dir, langs[0])

    js_dir = os.path.join(lang_dir, js_file)

    logger.info(f'starts {js_dir}')
    dataset = []
    hash_memory = []

    with open(os.path.join(js_dir), 'r') as f:
        for line in f:

            js = json.loads(line.strip())
            hash = js['hash']
            
            if hash in hash_memory:
                continue

            hash_memory.append(hash)
            dataset.append(js)   

        # write the dataset into json
        with open(os.path.join(save_dir, langs[0], f"{preprocess.get_filename(js_file)}.jsonl"), 'w') as data_f:
            for sample in dataset:
                data_f.write(json.dumps(sample) + '\n')
    logger.info(f'end {js_dir}')
                
        
# c
samples = ['mydata000000000044.jsonl', 'mydata000000000133.jsonl', 'mydata000000000279.jsonl', 'mydata000000000304.jsonl', 'mydata000000000319.jsonl', 'mydata000000000223.jsonl', 'mydata000000000105.jsonl', 'mydata000000000232.jsonl', 'mydata000000000352.jsonl', 'mydata000000000311.jsonl', 'mydata000000000288.jsonl', 'mydata000000000368.jsonl', 'mydata000000000212.jsonl', 'mydata000000000024.jsonl', 'mydata000000000238.jsonl', 'mydata000000000241.jsonl', 'mydata000000000246.jsonl', 'mydata000000000071.jsonl', 'mydata000000000262.jsonl', 'mydata000000000065.jsonl', 'mydata000000000034.jsonl', 'mydata000000000038.jsonl', 'mydata000000000321.jsonl', 'mydata000000000310.jsonl', 'mydata000000000337.jsonl', 'mydata000000000175.jsonl', 'mydata000000000082.jsonl', 'mydata000000000349.jsonl', 'mydata000000000290.jsonl', 'mydata000000000099.jsonl', 'mydata000000000267.jsonl', 'mydata000000000301.jsonl', 'mydata000000000240.jsonl', 'mydata000000000215.jsonl', 'mydata000000000222.jsonl', 'mydata000000000039.jsonl', 'mydata000000000364.jsonl', 'mydata000000000355.jsonl', 'mydata000000000260.jsonl', 'mydata000000000004.jsonl', 'mydata000000000344.jsonl', 'mydata000000000069.jsonl', 'mydata000000000117.jsonl', 'mydata000000000307.jsonl', 'mydata000000000224.jsonl', 'mydata000000000297.jsonl', 'mydata000000000208.jsonl', 'mydata000000000072.jsonl', 'mydata000000000164.jsonl', 'mydata000000000129.jsonl', 'mydata000000000374.jsonl', 'mydata000000000256.jsonl', 'mydata000000000315.jsonl', 'mydata000000000057.jsonl', 'mydata000000000198.jsonl', 'mydata000000000155.jsonl', 'mydata000000000145.jsonl', 'mydata000000000263.jsonl', 'mydata000000000165.jsonl', 'mydata000000000051.jsonl', 'mydata000000000104.jsonl', 'mydata000000000287.jsonl', 'mydata000000000124.jsonl', 'mydata000000000166.jsonl', 'mydata000000000242.jsonl', 'mydata000000000296.jsonl', 'mydata000000000026.jsonl', 'mydata000000000363.jsonl', 'mydata000000000019.jsonl', 'mydata000000000142.jsonl', 'mydata000000000203.jsonl', 'mydata000000000100.jsonl', 'mydata000000000052.jsonl', 'mydata000000000183.jsonl', 'mydata000000000335.jsonl', 'mydata000000000234.jsonl', 'mydata000000000243.jsonl', 'mydata000000000086.jsonl', 'mydata000000000229.jsonl', 'mydata000000000293.jsonl', 'mydata000000000302.jsonl', 'mydata000000000318.jsonl', 'mydata000000000369.jsonl', 'mydata000000000163.jsonl', 'mydata000000000006.jsonl', 'mydata000000000342.jsonl', 'mydata000000000179.jsonl', 'mydata000000000150.jsonl', 'mydata000000000322.jsonl', 'mydata000000000144.jsonl', 'mydata000000000217.jsonl', 'mydata000000000098.jsonl', 'mydata000000000101.jsonl', 'mydata000000000257.jsonl', 'mydata000000000154.jsonl', 'mydata000000000291.jsonl', 'mydata000000000195.jsonl', 'mydata000000000128.jsonl', 'mydata000000000081.jsonl', 'mydata000000000192.jsonl', 'mydata000000000181.jsonl', 'mydata000000000014.jsonl', 'mydata000000000022.jsonl', 'mydata000000000194.jsonl', 'mydata000000000041.jsonl', 'mydata000000000029.jsonl', 'mydata000000000286.jsonl', 'mydata000000000334.jsonl', 'mydata000000000375.jsonl', 'mydata000000000372.jsonl', 'mydata000000000060.jsonl', 'mydata000000000320.jsonl', 'mydata000000000032.jsonl', 'mydata000000000361.jsonl', 'mydata000000000091.jsonl', 'mydata000000000357.jsonl', 'mydata000000000076.jsonl', 'mydata000000000221.jsonl', 'mydata000000000284.jsonl', 'mydata000000000202.jsonl', 'mydata000000000147.jsonl', 'mydata000000000168.jsonl', 'mydata000000000219.jsonl', 'mydata000000000146.jsonl', 'mydata000000000306.jsonl', 'mydata000000000080.jsonl', 'mydata000000000096.jsonl', 'mydata000000000027.jsonl', 'mydata000000000020.jsonl', 'mydata000000000112.jsonl', 'mydata000000000278.jsonl', 'mydata000000000373.jsonl', 'mydata000000000339.jsonl', 'mydata000000000189.jsonl', 'mydata000000000083.jsonl', 'mydata000000000236.jsonl', 'mydata000000000087.jsonl', 'mydata000000000067.jsonl', 'mydata000000000362.jsonl', 'mydata000000000061.jsonl', 'mydata000000000048.jsonl', 'mydata000000000247.jsonl', 'mydata000000000300.jsonl', 'mydata000000000053.jsonl', 'mydata000000000188.jsonl', 'mydata000000000383.jsonl', 'mydata000000000158.jsonl', 'mydata000000000172.jsonl', 'mydata000000000285.jsonl', 'mydata000000000204.jsonl', 'mydata000000000064.jsonl', 'mydata000000000035.jsonl', 'mydata000000000170.jsonl', 'mydata000000000003.jsonl', 'mydata000000000340.jsonl', 'mydata000000000050.jsonl', 'mydata000000000327.jsonl', 'mydata000000000182.jsonl', 'mydata000000000330.jsonl', 'mydata000000000174.jsonl', 'mydata000000000171.jsonl', 'mydata000000000199.jsonl', 'mydata000000000046.jsonl', 'mydata000000000185.jsonl', 'mydata000000000109.jsonl', 'mydata000000000205.jsonl', 'mydata000000000120.jsonl', 'mydata000000000326.jsonl', 'mydata000000000002.jsonl', 'mydata000000000148.jsonl', 'mydata000000000303.jsonl', 'mydata000000000184.jsonl', 'mydata000000000018.jsonl', 'mydata000000000167.jsonl', 'mydata000000000250.jsonl', 'mydata000000000378.jsonl', 'mydata000000000323.jsonl', 'mydata000000000126.jsonl', 'mydata000000000107.jsonl', 'mydata000000000316.jsonl', 'mydata000000000213.jsonl', 'mydata000000000009.jsonl', 'mydata000000000137.jsonl', 'mydata000000000216.jsonl', 'mydata000000000338.jsonl', 'mydata000000000127.jsonl', 'mydata000000000028.jsonl', 'mydata000000000261.jsonl', 'mydata000000000356.jsonl', 'mydata000000000130.jsonl', 'mydata000000000162.jsonl', 'mydata000000000196.jsonl', 'mydata000000000360.jsonl', 'mydata000000000281.jsonl', 'mydata000000000275.jsonl', 'mydata000000000025.jsonl', 'mydata000000000151.jsonl', 'mydata000000000258.jsonl', 'mydata000000000274.jsonl', 'mydata000000000094.jsonl', 'mydata000000000237.jsonl', 'mydata000000000030.jsonl', 'mydata000000000159.jsonl', 'mydata000000000033.jsonl', 'mydata000000000382.jsonl', 'mydata000000000379.jsonl', 'mydata000000000152.jsonl', 'mydata000000000209.jsonl', 'mydata000000000225.jsonl', 'mydata000000000331.jsonl', 'mydata000000000239.jsonl', 'mydata000000000073.jsonl', 'mydata000000000341.jsonl', 'mydata000000000169.jsonl', 'mydata000000000095.jsonl', 'mydata000000000113.jsonl', 'mydata000000000348.jsonl', 'mydata000000000314.jsonl', 'mydata000000000276.jsonl', 'mydata000000000010.jsonl', 'mydata000000000317.jsonl', 'mydata000000000358.jsonl', 'mydata000000000345.jsonl', 'mydata000000000173.jsonl', 'mydata000000000218.jsonl', 'mydata000000000200.jsonl', 'mydata000000000143.jsonl', 'mydata000000000121.jsonl', 'mydata000000000266.jsonl', 'mydata000000000201.jsonl', 'mydata000000000106.jsonl', 'mydata000000000015.jsonl', 'mydata000000000214.jsonl', 'mydata000000000066.jsonl', 'mydata000000000005.jsonl', 'mydata000000000180.jsonl', 'mydata000000000153.jsonl', 'mydata000000000111.jsonl', 'mydata000000000233.jsonl', 'mydata000000000149.jsonl', 'mydata000000000047.jsonl', 'mydata000000000007.jsonl', 'mydata000000000377.jsonl', 'mydata000000000013.jsonl', 'mydata000000000090.jsonl', 'mydata000000000031.jsonl', 'mydata000000000251.jsonl', 'mydata000000000354.jsonl', 'mydata000000000365.jsonl', 'mydata000000000040.jsonl', 'mydata000000000049.jsonl', 'mydata000000000228.jsonl', 'mydata000000000193.jsonl', 'mydata000000000197.jsonl', 'mydata000000000336.jsonl', 'mydata000000000023.jsonl', 'mydata000000000289.jsonl', 'mydata000000000259.jsonl', 'mydata000000000011.jsonl', 'mydata000000000070.jsonl', 'mydata000000000255.jsonl', 'mydata000000000270.jsonl', 'mydata000000000292.jsonl', 'mydata000000000132.jsonl', 'mydata000000000108.jsonl', 'mydata000000000068.jsonl', 'mydata000000000012.jsonl', 'mydata000000000178.jsonl', 'mydata000000000097.jsonl', 'mydata000000000254.jsonl', 'mydata000000000220.jsonl', 'mydata000000000131.jsonl', 'mydata000000000116.jsonl', 'mydata000000000353.jsonl', 'mydata000000000376.jsonl', 'mydata000000000056.jsonl', 'mydata000000000125.jsonl', 'mydata000000000077.jsonl', 'mydata000000000008.jsonl', 'mydata000000000136.jsonl', 'mydata000000000343.jsonl', 'mydata000000000110.jsonl', 'mydata000000000280.jsonl', 'mydata000000000277.jsonl', 'mydata000000000235.jsonl', 'mydata000000000045.jsonl', 'mydata000000000271.jsonl']

# cpp
samples = ['cpp000000000096.jsonl', 'cpp000000000343.jsonl', 'cpp000000000129.jsonl', 'cpp000000000153.jsonl', 'cpp000000000279.jsonl', 'cpp000000000045.jsonl', 'cpp000000000235.jsonl', 'cpp000000000407.jsonl', 'cpp000000000082.jsonl', 'cpp000000000048.jsonl', 'cpp000000000238.jsonl', 'cpp000000000099.jsonl', 'cpp000000000483.jsonl', 'cpp000000000386.jsonl', 'cpp000000000197.jsonl', 'cpp000000000069.jsonl', 'cpp000000000236.jsonl', 'cpp000000000097.jsonl', 'cpp000000000215.jsonl', 'cpp000000000098.jsonl', 'cpp000000000385.jsonl', 'cpp000000000148.jsonl', 'cpp000000000481.jsonl', 'cpp000000000029.jsonl', 'cpp000000000127.jsonl', 'cpp000000000223.jsonl', 'cpp000000000303.jsonl', 'cpp000000000132.jsonl', 'cpp000000000218.jsonl', 'cpp000000000070.jsonl', 'cpp000000000452.jsonl', 'cpp000000000172.jsonl', 'cpp000000000106.jsonl', 'cpp000000000149.jsonl', 'cpp000000000256.jsonl', 'cpp000000000144.jsonl', 'cpp000000000112.jsonl', 'cpp000000000254.jsonl', 'cpp000000000196.jsonl', 'cpp000000000471.jsonl', 'cpp000000000473.jsonl', 'cpp000000000404.jsonl', 'cpp000000000341.jsonl', 'cpp000000000292.jsonl', 'cpp000000000124.jsonl', 'cpp000000000146.jsonl', 'cpp000000000012.jsonl', 'cpp000000000080.jsonl', 'cpp000000000261.jsonl', 'cpp000000000464.jsonl', 'cpp000000000046.jsonl', 'cpp000000000499.jsonl', 'cpp000000000073.jsonl', 'cpp000000000427.jsonl', 'cpp000000000388.jsonl', 'cpp000000000240.jsonl', 'cpp000000000024.jsonl', 'cpp000000000251.jsonl', 'cpp000000000384.jsonl', 'cpp000000000376.jsonl', 'cpp000000000214.jsonl', 'cpp000000000322.jsonl', 'cpp000000000286.jsonl', 'cpp000000000495.jsonl', 'cpp000000000027.jsonl', 'cpp000000000378.jsonl', 'cpp000000000480.jsonl', 'cpp000000000316.jsonl', 'cpp000000000198.jsonl', 'cpp000000000393.jsonl', 'cpp000000000387.jsonl', 'cpp000000000125.jsonl', 'cpp000000000494.jsonl', 'cpp000000000130.jsonl', 'cpp000000000095.jsonl', 'cpp000000000390.jsonl', 'cpp000000000318.jsonl', 'cpp000000000451.jsonl', 'cpp000000000167.jsonl', 'cpp000000000438.jsonl', 'cpp000000000361.jsonl', 'cpp000000000409.jsonl', 'cpp000000000270.jsonl', 'cpp000000000164.jsonl', 'cpp000000000263.jsonl', 'cpp000000000482.jsonl', 'cpp000000000200.jsonl', 'cpp000000000466.jsonl', 'cpp000000000362.jsonl', 'cpp000000000258.jsonl', 'cpp000000000083.jsonl', 'cpp000000000274.jsonl', 'cpp000000000278.jsonl', 'cpp000000000025.jsonl', 'cpp000000000497.jsonl', 'cpp000000000391.jsonl', 'cpp000000000425.jsonl', 'cpp000000000448.jsonl', 'cpp000000000374.jsonl', 'cpp000000000287.jsonl', 'cpp000000000053.jsonl', 'cpp000000000432.jsonl', 'cpp000000000446.jsonl', 'cpp000000000011.jsonl', 'cpp000000000262.jsonl', 'cpp000000000465.jsonl', 'cpp000000000201.jsonl', 'cpp000000000429.jsonl', 'cpp000000000199.jsonl', 'cpp000000000006.jsonl', 'cpp000000000168.jsonl', 'cpp000000000375.jsonl', 'cpp000000000239.jsonl', 'cpp000000000412.jsonl', 'cpp000000000317.jsonl', 'cpp000000000260.jsonl', 'cpp000000000038.jsonl', 'cpp000000000166.jsonl', 'cpp000000000496.jsonl', 'cpp000000000457.jsonl', 'cpp000000000241.jsonl', 'cpp000000000445.jsonl', 'cpp000000000428.jsonl', 'cpp000000000424.jsonl', 'cpp000000000472.jsonl', 'cpp000000000302.jsonl', 'cpp000000000315.jsonl', 'cpp000000000203.jsonl', 'cpp000000000222.jsonl', 'cpp000000000314.jsonl', 'cpp000000000276.jsonl', 'cpp000000000354.jsonl', 'cpp000000000467.jsonl', 'cpp000000000133.jsonl', 'cpp000000000340.jsonl', 'cpp000000000339.jsonl', 'cpp000000000171.jsonl', 'cpp000000000259.jsonl', 'cpp000000000288.jsonl', 'cpp000000000413.jsonl', 'cpp000000000352.jsonl', 'cpp000000000291.jsonl', 'cpp000000000170.jsonl', 'cpp000000000377.jsonl', 'cpp000000000277.jsonl', 'cpp000000000342.jsonl', 'cpp000000000010.jsonl', 'cpp000000000433.jsonl', 'cpp000000000113.jsonl', 'cpp000000000072.jsonl', 'cpp000000000363.jsonl', 'cpp000000000453.jsonl', 'cpp000000000217.jsonl', 'cpp000000000379.jsonl', 'cpp000000000242.jsonl', 'cpp000000000049.jsonl', 'cpp000000000357.jsonl', 'cpp000000000032.jsonl', 'cpp000000000359.jsonl', 'cpp000000000150.jsonl', 'cpp000000000030.jsonl', 'cpp000000000105.jsonl', 'cpp000000000408.jsonl', 'cpp000000000447.jsonl', 'cpp000000000243.jsonl', 'cpp000000000289.jsonl', 'cpp000000000392.jsonl', 'cpp000000000182.jsonl', 'cpp000000000175.jsonl', 'cpp000000000411.jsonl', 'cpp000000000290.jsonl', 'cpp000000000319.jsonl', 'cpp000000000360.jsonl', 'cpp000000000220.jsonl', 'cpp000000000152.jsonl', 'cpp000000000007.jsonl', 'cpp000000000355.jsonl', 'cpp000000000194.jsonl', 'cpp000000000320.jsonl', 'cpp000000000410.jsonl', 'cpp000000000406.jsonl', 'cpp000000000237.jsonl', 'cpp000000000430.jsonl', 'cpp000000000051.jsonl', 'cpp000000000180.jsonl', 'cpp000000000111.jsonl', 'cpp000000000426.jsonl', 'cpp000000000431.jsonl', 'cpp000000000337.jsonl', 'cpp000000000064.jsonl', 'cpp000000000300.jsonl', 'cpp000000000195.jsonl', 'cpp000000000009.jsonl', 'cpp000000000216.jsonl', 'cpp000000000108.jsonl', 'cpp000000000373.jsonl', 'cpp000000000321.jsonl', 'cpp000000000110.jsonl', 'cpp000000000131.jsonl', 'cpp000000000335.jsonl', 'cpp000000000450.jsonl', 'cpp000000000169.jsonl', 'cpp000000000301.jsonl', 'cpp000000000358.jsonl', 'cpp000000000444.jsonl', 'cpp000000000181.jsonl', 'cpp000000000234.jsonl', 'cpp000000000202.jsonl', 'cpp000000000419.jsonl', 'cpp000000000257.jsonl', 'cpp000000000338.jsonl', 'cpp000000000469.jsonl', 'cpp000000000154.jsonl', 'cpp000000000334.jsonl', 'cpp000000000126.jsonl', 'cpp000000000109.jsonl', 'cpp000000000151.jsonl', 'cpp000000000026.jsonl', 'cpp000000000293.jsonl', 'cpp000000000104.jsonl', 'cpp000000000336.jsonl', 'cpp000000000255.jsonl', 'cpp000000000173.jsonl', 'cpp000000000470.jsonl', 'cpp000000000219.jsonl', 'cpp000000000052.jsonl', 'cpp000000000028.jsonl', 'cpp000000000476.jsonl', 'cpp000000000067.jsonl', 'cpp000000000284.jsonl', 'cpp000000000221.jsonl', 'cpp000000000081.jsonl', 'cpp000000000323.jsonl', 'cpp000000000183.jsonl', 'cpp000000000468.jsonl', 'cpp000000000275.jsonl', 'cpp000000000356.jsonl', 'cpp000000000449.jsonl', 'cpp000000000405.jsonl', 'cpp000000000389.jsonl', 'cpp000000000285.jsonl', 'cpp000000000188.jsonl', 'cpp000000000107.jsonl', 'cpp000000000498.jsonl', 'cpp000000000165.jsonl']
with ThreadPoolExecutor(max_workers=50) as executor:
    executor.map(remove_dups, samples)



